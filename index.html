<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JS Grand Prix: Montreal Corrected</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; user-select: none; }
        canvas { display: block; }
        
        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* HUD */
        .hud-panel { position: absolute; padding: 10px 15px; background: rgba(0,0,0,0.8); color: white; border-left: 4px solid #e63946; font-weight: bold; font-family: monospace; font-size: 20px; skew: -10deg; }
        #stats { top: 20px; left: 20px; }
        #times { top: 20px; right: 20px; text-align: right; border-left: none; border-right: 4px solid #e63946; }
        
        #speedometer {
            position: absolute; bottom: 20px; right: 20px;
            width: 240px; height: 120px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            border-bottom: 4px solid #e63946;
            text-align: right; padding: 10px; box-sizing: border-box;
        }
        .speed-val { font-size: 50px; color: #fff; font-family: monospace; font-weight: 900; }
        .speed-unit { font-size: 14px; color: #aaa; }
        .gear-disp { font-size: 30px; color: yellow; float: left; font-weight: bold; margin-top: 15px; margin-left: 10px; }

        /* Warning Box */
        #warning-box {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            font-family: monospace; font-weight: bold; font-size: 18px;
            border-left: 4px solid orange; transform: skew(-10deg);
        }

        /* Main Menu */
        #main-menu, #pause-menu, #results-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #2a2a2a, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 10;
        }
        
        #pause-menu { background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        
        /* RESULTS MENU SPECIFIC */
        #results-menu { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
        .result-box {
            border: 2px solid #444; background: #222; padding: 40px; text-align: center;
            width: 400px; transform: skew(-5deg); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .result-pos { font-size: 80px; font-weight: 900; color: #e63946; margin: 0; line-height: 1; }
        .result-label { color: #888; font-size: 14px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
        .result-time { font-family: monospace; font-size: 30px; color: white; margin-bottom: 20px; }

        h1 { color: #fff; font-size: 70px; font-style: italic; text-transform: uppercase; margin: 0; text-shadow: 4px 4px #e63946; letter-spacing: 5px; }
        h2 { color: #aaa; font-size: 40px; margin-bottom: 30px; text-transform: uppercase; font-style: italic; }

        .menu-row { display: flex; gap: 30px; margin: 20px 0; align-items: flex-start; }
        .menu-col { display: flex; flex-direction: column; gap: 10px; }
        
        select, button {
            padding: 15px 30px; font-size: 18px; background: #333; color: white; border: 2px solid #555;
            cursor: pointer; font-family: inherit; text-transform: uppercase; font-weight: bold; width: 250px;
        }
        select:hover, button:hover { border-color: #e63946; background: #444; }
        
        .team-desc {
            width: 250px; min-height: 80px; background: #222; border: 1px solid #444; color: #ccc;
            padding: 10px; font-size: 14px; line-height: 1.4; font-style: italic;
        }
        .stat-good { color: #4ade80; }
        .stat-neutral { color: #fff; }
        .stat-bad { color: #f87171; }
        
        .btn-start {
            background: #e63946; border: none; font-size: 28px; padding: 20px 80px; transform: skew(-10deg);
            box-shadow: 0 0 20px rgba(230, 57, 70, 0.5); width: auto; margin-top: 20px;
        }
        .btn-start:hover { background: #ff4d5a; transform: skew(-10deg) scale(1.05); }

        /* Messages */
        #center-msg { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 90px; font-weight: 900; color: yellow; 
            text-shadow: 4px 4px 0 #000; text-align: center; font-style: italic;
        }
        #penalty-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0.3); display: none;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 40px; font-weight: 900; font-style: italic;
            text-shadow: 2px 2px 0 #000; z-index: 5;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="main-menu">
    <h1>Formula JS</h1>
    <div style="color:#888; margin-bottom: 20px;">v1.8 - MONTREAL FIX</div>
    
    <div class="menu-row">
        <div class="menu-col">
            <label style="color:#aaa; font-size:14px;">CIRCUIT</label>
            <select id="map-select">
                <option value="SILVERSTONE">Silverstone (UK)</option>
                <option value="SPA">Spa (Belgium)</option>
                <option value="MONZA">Monza (Italy)</option>
                <option value="SUZUKA">Suzuka (Japan)</option>
                <option value="AUSTRIA">Austria (Red Bull Ring)</option>
                <option value="INTERLAGOS">Interlagos (Brazil)</option>
                <option value="MONTREAL" selected>Montreal (Canada)</option>
            </select>

            <label style="color:#aaa; font-size:14px; margin-top: 10px;">DIFFICULTY & RULES</label>
            <select id="diff-select">
                <option value="ROOKIE">Rookie (No Penalties)</option>
                <option value="PRO" selected>Pro (5s Stop Penalty)</option>
                <option value="LEGEND">Legend (10s Stop Penalty)</option>
            </select>
        </div>

        <div class="menu-col">
            <label style="color:#aaa; font-size:14px;">SELECT TEAM</label>
            <select id="team-select" onchange="updateTeamDesc()">
                </select>
            <div id="team-desc-box" class="team-desc"></div>
        </div>
    </div>

    <button class="btn-start" onclick="startGame()">START RACE</button>
</div>

<div id="pause-menu" class="hidden">
    <h2>RACE PAUSED</h2>
    <button onclick="togglePause()">RESUME</button>
    <button onclick="showMenu()" style="margin-top: 10px;">MAIN MENU</button>
</div>

<div id="results-menu" class="hidden">
    <h1>FINISHED</h1>
    <div class="result-box">
        <div class="result-label">POSITION</div>
        <div id="res-pos" class="result-pos">P1</div>
        <br>
        <div class="result-label">TOTAL TIME</div>
        <div id="res-time" class="result-time">0:00.00</div>
        
        <div class="result-label">BEST LAP</div>
        <div id="res-best" class="result-time" style="color:#aaa; font-size: 24px;">0:00.00</div>
    </div>
    <div style="margin-top: 20px;">
        <button onclick="restartRace()">RESTART</button>
        <button onclick="showMenu()" style="background:#444; margin-left:10px;">MENU</button>
    </div>
</div>

<div id="ui-layer" class="hidden">
    <div id="penalty-overlay" class="hidden">
        <div>
            PENALTY<br>
            <span id="penalty-timer" style="font-size:60px; color:yellow;">5.0</span>s
        </div>
    </div>

    <div id="stats" class="hud-panel">
        POS: <span id="pos-disp">--</span>/16<br>
        LAP: <span id="lap-disp">1</span>/5
    </div>
    <div id="times" class="hud-panel">
        TIME: <span id="cur-time">0.00</span><br>
        LAST: <span id="last-lap">--:--</span>
    </div>
    <div id="speedometer">
        <div class="gear-disp" id="gear">N</div>
        <span class="speed-val" id="speed">0</span> <span class="speed-unit">KM/H</span>
    </div>
    <div id="warning-box">
        WARNINGS: <span id="warn-count">0</span>/5
    </div>
    <div id="center-msg"></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
/** CONSTANTS & CONFIG */
const TOTAL_LAPS = 5;
const TOTAL_CARS = 16;
const TRACK_WIDTH = 150; 
const BASE_FRICTION_ROAD = 0.98; 
const BASE_FRICTION_GRASS = 0.88; 
const BASE_ACCEL = 0.2;
const BASE_MAX_SPEED = 16;
const BASE_TURN_SPEED = 0.065;

/** TEAMS DATA */
const TEAMS = [
    { id: 0, name: "Scuderia Rosso", color: "#d90429", speed: 1.01, handling: 1.00, grip: 1.00, desc: "<span class='stat-good'>Balanced Spec</span><br>Slight edge on straights." },
    { id: 1, name: "Cyan Arrow", color: "#00f5d4", speed: 1.00, handling: 1.00, grip: 1.00, desc: "<span class='stat-good'>Balanced Spec</span><br>Standard setup." },
    { id: 2, name: "Bull Racing", color: "#001d3d", speed: 1.005, handling: 1.005, grip: 1.00, desc: "<span class='stat-good'>Balanced Spec</span><br>Very agile." },
    { id: 3, name: "Papaya Speed", color: "#fb8500", speed: 1.01, handling: 0.99, grip: 1.00, desc: "<span class='stat-good'>Balanced Spec</span><br>Aggressive gearing." },
    { id: 4, name: "Verde Martin", color: "#006400", speed: 1.00, handling: 1.01, grip: 1.00, desc: "<span class='stat-good'>Balanced Spec</span><br>Good turn-in." },
    { id: 5, name: "Alpine Blue", color: "#4361ee", speed: 1.00, handling: 1.00, grip: 1.00, desc: "<span class='stat-good'>Balanced Spec</span><br>Standard setup." },
    { id: 6, name: "Violet GP", color: "#7209b7", speed: 0.99, handling: 1.01, grip: 1.01, desc: "<span class='stat-good'>Balanced Spec</span><br>High Downforce." },
    { id: 7, name: "Sunny F1", color: "#ffea00", speed: 1.00, handling: 0.99, grip: 1.01, desc: "<span class='stat-good'>Balanced Spec</span><br>Reliable." }
];

/** MAPS */
const MAPS = {
    "SILVERSTONE": [
        {x:0, y:-1000}, {x:200, y:-1400}, {x:600, y:-1400}, 
        {x:800, y:-1100}, {x:1000, y:-1400}, {x:1200, y:-1100}, 
        {x:1600, y:-1100}, {x:2000, y:-800}, {x:2000, y:-400}, 
        {x:1500, y:-400}, {x:1200, y:-100}, {x:800, y:-400}, 
        {x:0, y:800}, {x:0, y:0}
    ],
    "SPA": [
        {x:0, y:-600}, {x:300, y:-400}, {x:300, y:0}, {x:0, y:400}, 
        {x:-400, y:800}, {x:-400, y:1200}, {x:-200, y:1400}, {x:0, y:1600}, 
        {x:1000, y:2000}, {x:1400, y:1800}, {x:1600, y:2000}, {x:1400, y:2200}, 
        {x:400, y:2200}, {x:-200, y:2000}, {x:-400, y:2200}, 
        {x:0, y:1000}, {x:0, y:0}
    ],
    "MONZA": [
        {x:0, y:-1500}, {x:200, y:-1800}, {x:400, y:-1500}, 
        {x:600, y:-1200}, {x:1200, y:-1200}, {x:1400, y:-1000}, {x:1200, y:-800}, 
        {x:800, y:0}, {x:600, y:200}, {x:400, y:0}, {x:200, y:200}, 
        {x:-200, y:400}, {x:-600, y:200}, {x:0, y:1000}, {x:0, y:0}
    ],
    "SUZUKA": [
        {x:0, y:-800}, {x:400, y:-1000}, {x:600, y:-800}, {x:800, y:-1000}, {x:1000, y:-800}, 
        {x:1200, y:-1200}, {x:1400, y:-1000}, {x:1400, y:-600}, {x:1000, y:-600}, 
        {x:600, y:-400}, {x:1200, y:0}, {x:1600, y:200}, {x:1400, y:600}, 
        {x:200, y:400}, {x:-100, y:600}, {x:-300, y:400}, {x:0, y:800}, {x:0, y:0}
    ],
    "AUSTRIA": [ 
        {x:0, y:-800}, {x:200, y:-1000}, {x:600, y:-1000}, 
        {x:1200, y:-1200}, {x:1400, y:-1000}, 
        {x:1200, y:-400}, {x:1000, y:-200}, 
        {x:600, y:-200}, {x:400, y:-400}, {x:200, y:-200}, 
        {x:0, y:600}, {x:0, y:0}
    ],
    "INTERLAGOS": [ 
        {x:0, y:-600}, {x:-200, y:-800}, {x:0, y:-1000}, {x:200, y:-800}, 
        {x:200, y:0}, {x:600, y:200}, {x:800, y:0}, 
        {x:1000, y:200}, {x:1200, y:0}, 
        {x:800, y:-400}, {x:600, y:-200}, 
        {x:-400, y:400}, 
        {x:0, y:600}, {x:0, y:0}
    ],
    "MONTREAL": [ 
        // ORIGINAL LAYOUT (Positive X), BUT REVERSED ORDER (See startGame)
        {x: 0, y: 0},
        {x: 1000, y: 0},
        {x: 1200, y: -100}, {x: 1200, y: -300}, {x: 1000, y: -400},
        {x: 800, y: -400}, {x: 800, y: -700}, 
        {x: 500, y: -700}, {x: 500, y: -1100}, 
        {x: 300, y: -1200}, {x: 100, y: -1100}, {x: 200, y: -900},
        {x: 0, y: -1000}, {x: -200, y: -1200}, {x: -400, y: -1100}, 
        {x: -500, y: -900}, {x: -400, y: -700}, 
        {x: -200, y: -500}, {x: -300, y: -300},
        {x: -600, y: -200}, {x: -700, y: 0},
        {x: 0, y: 0}
    ]
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width, height;

// State Variables
let keys = { w: false, a: false, s: false, d: false };
let mouse = { x: 0, y: 0 };
let cars = [];
let gameState = 'MENU'; 
let camera = { x: 0, y: 0 };
let activeTrack = [];
let trackStartAngle = 0; 
let grandstands = []; 
let difficultySetting = "PRO"; 
let countdownTimer = null;
let selectedTeamId = 1;

/** UTILITIES */
function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

window.addEventListener('mousemove', e => {
    mouse.x = e.clientX - width / 2;
    mouse.y = e.clientY - height / 2;
});
window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if (e.key === "Escape") togglePause();
});
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
function dist(x1, y1, x2, y2) { return Math.sqrt((x2-x1)**2 + (y2-y1)**2); }

/** POPULATE MENU */
const teamSelect = document.getElementById('team-select');
TEAMS.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.innerText = t.name;
    teamSelect.appendChild(opt);
});
updateTeamDesc();

function updateTeamDesc() {
    const id = parseInt(document.getElementById('team-select').value);
    const t = TEAMS.find(x => x.id === id);
    document.getElementById('team-desc-box').innerHTML = t.desc;
    document.getElementById('team-desc-box').style.borderLeft = `4px solid ${t.color}`;
}

function togglePause() {
    if (gameState === 'RACING') {
        gameState = 'PAUSED';
        document.getElementById('pause-menu').classList.remove('hidden');
    } else if (gameState === 'PAUSED') {
        gameState = 'RACING';
        document.getElementById('pause-menu').classList.add('hidden');
    }
}

/** CAR CLASS */
class Car {
    constructor(isPlayer, startX, startY, startAngle, teamData, skillLevel, id) {
        this.isPlayer = isPlayer;
        this.x = startX;
        this.y = startY;
        this.angle = startAngle; 
        this.vx = 0;
        this.vy = 0;
        this.color = teamData.color;
        this.id = id;
        
        let diffSpeedMod = 1.0;
        let diffGripMod = 1.0;

        if (!isPlayer) {
            if (difficultySetting === "ROOKIE") {
                diffSpeedMod = 0.90; diffGripMod = 0.95;  
            } else if (difficultySetting === "LEGEND") {
                diffSpeedMod = 1.04; diffGripMod = 1.20;
            }
        }

        this.maxSpeed = BASE_MAX_SPEED * teamData.speed * diffSpeedMod;
        this.turnRate = BASE_TURN_SPEED * teamData.handling;
        this.grip = teamData.grip * diffGripMod;
        
        this.lap = 1;
        this.raceStartTime = 0; 
        this.currentLapStart = 0;
        this.lastLapTime = 0;
        this.bestLapTime = 9999;
        this.totalRaceTime = 0; 
        this.nextWaypointIndex = 0; 
        this.finished = false;
        
        this.hasCrossedStartLine = false;

        this.aiSkill = skillLevel; 
        this.turnError = (Math.random() - 0.5) * (0.3 / skillLevel); 
        
        this.offTrackTimer = 0; 
        this.warningCount = 0;
        this.stopPenaltyTime = 0; 
    }

    update() {
        if (gameState !== 'RACING' && gameState !== 'FINISHED') return;
        
        if (this.finished) {
            this.vx *= 0.9; this.vy *= 0.9;
            this.x += this.vx; this.y += this.vy;
            return;
        }

        if (this.stopPenaltyTime > 0) {
            this.vx = 0; this.vy = 0;
            this.stopPenaltyTime -= 1/60; 
            if (this.isPlayer) {
                document.getElementById('penalty-overlay').classList.remove('hidden');
                document.getElementById('penalty-timer').innerText = this.stopPenaltyTime.toFixed(1);
            }
            if (this.stopPenaltyTime <= 0) {
                this.stopPenaltyTime = 0;
                if (this.isPlayer) document.getElementById('penalty-overlay').classList.add('hidden');
            } else {
                return; 
            }
        }

        const speed = Math.sqrt(this.vx**2 + this.vy**2);

        if (this.isPlayer && gameState === 'RACING') {
            if (keys.w) { this.vx += Math.cos(this.angle)*BASE_ACCEL; this.vy += Math.sin(this.angle)*BASE_ACCEL; }
            if (keys.s) { this.vx -= Math.cos(this.angle)*BASE_ACCEL*0.5; this.vy -= Math.sin(this.angle)*BASE_ACCEL*0.5; }
            if (speed > 0.5) {
                const dir = (this.vx*Math.cos(this.angle) + this.vy*Math.sin(this.angle)) > 0 ? 1 : -1;
                if (keys.a) this.angle -= this.turnRate * dir;
                if (keys.d) this.angle += this.turnRate * dir;
            }
        } else if (!this.isPlayer && gameState === 'RACING') {
            this.runAI();
        }

        const onTrack = isPointInTrack(this.x, this.y);
        let friction = onTrack ? (BASE_FRICTION_ROAD * this.grip) : BASE_FRICTION_GRASS;
        if (friction > 0.99) friction = 0.99;
        this.vx *= friction; this.vy *= friction;

        let limit = this.maxSpeed;
        if (!onTrack) {
            limit = BASE_MAX_SPEED * 0.4;
            if (speed > 4) {
                this.offTrackTimer++;
                if (this.offTrackTimer % 100 === 1) this.addWarning();
            }
        } else {
            this.offTrackTimer = 0;
        }

        if (speed > limit) {
            const r = limit / speed;
            this.vx *= r; this.vy *= r;
        }

        this.x += this.vx; this.y += this.vy;
        this.checkWaypoints();
    }

    addWarning() {
        this.warningCount++;
        if (this.isPlayer) {
            const warnUi = document.getElementById('warn-count');
            warnUi.innerText = this.warningCount;
            warnUi.style.color = this.warningCount >= 4 ? "red" : "white";
        }
        if (this.warningCount >= 5) this.triggerPenalty();
    }

    triggerPenalty() {
        if (difficultySetting === "ROOKIE") return;
        let penaltySeconds = (difficultySetting === "PRO") ? 5 : 10;
        this.stopPenaltyTime = penaltySeconds;
        this.warningCount = 0; 
        if (this.isPlayer) document.getElementById('warn-count').innerText = "0";
    }

    runAI() {
        let target = activeTrack[this.nextWaypointIndex];
        const timeVal = Date.now() * 0.005;
        const jitterX = Math.sin(timeVal + this.id) * (20 / this.aiSkill);
        
        const dx = (target.x + jitterX) - this.x;
        const dy = target.y - this.y;
        const targetAngle = Math.atan2(dy, dx);
        
        let diff = (targetAngle + this.turnError) - this.angle;
        while (diff <= -Math.PI) diff += Math.PI*2;
        while (diff > Math.PI) diff -= Math.PI*2;

        if (diff > this.turnRate) this.angle += this.turnRate;
        else if (diff < -this.turnRate) this.angle -= this.turnRate;
        else this.angle += diff;

        let cornerSlowdown = 1.0;
        if (Math.abs(diff) > 0.3) {
            if (difficultySetting === "ROOKIE") cornerSlowdown = 0.3; 
            else if (difficultySetting === "PRO") cornerSlowdown = 0.5;
            else if (difficultySetting === "LEGEND") cornerSlowdown = 0.8; 
        }
        
        this.vx += Math.cos(this.angle) * (BASE_ACCEL * this.aiSkill * cornerSlowdown);
        this.vy += Math.sin(this.angle) * (BASE_ACCEL * this.aiSkill * cornerSlowdown);
    }

    checkWaypoints() {
        const target = activeTrack[this.nextWaypointIndex];
        if (dist(this.x, this.y, target.x, target.y) < TRACK_WIDTH * 1.5) {
            this.nextWaypointIndex++;
            if (this.nextWaypointIndex >= activeTrack.length) this.nextWaypointIndex = 0;
            
            if (this.nextWaypointIndex === 1) {
                if (this.hasCrossedStartLine) {
                    this.completeLap();
                } else {
                    this.hasCrossedStartLine = true;
                }
            }
        }
    }

    completeLap() {
        const now = Date.now();
        if (this.currentLapStart > 0) {
            this.lastLapTime = (now - this.currentLapStart) / 1000;
            if(this.lastLapTime < this.bestLapTime) this.bestLapTime = this.lastLapTime;
        }
        this.currentLapStart = now;
        this.lap++;
        if (this.lap > TOTAL_LAPS) {
            this.finished = true;
            // CALCULATE FINAL RACE TIME
            this.totalRaceTime = (now - this.raceStartTime) / 1000;
        }
    }

    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);

        ctx.fillStyle = "#111";
        ctx.fillRect(10, -14, 10, 6); ctx.fillRect(10, 8, 10, 6);
        ctx.fillRect(-18, -15, 12, 8); ctx.fillRect(-18, 7, 12, 8);

        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.moveTo(22, 0); ctx.lineTo(5, -4); ctx.lineTo(5, 4); ctx.fill();
        ctx.fillRect(-10, -5, 20, 10);
        ctx.fillRect(-12, -10, 14, 6); ctx.fillRect(-12, 4, 14, 6);

        ctx.fillStyle = this.isPlayer ? "#222" : "#333";
        ctx.fillRect(20, -14, 4, 28);
        ctx.fillRect(-22, -12, 6, 24);

        ctx.fillStyle = this.isPlayer ? "#fff" : "#ff0";
        ctx.beginPath(); ctx.arc(-2, 0, 3.5, 0, Math.PI*2); ctx.fill();
        
        if (this.stopPenaltyTime > 0) {
            ctx.restore(); 
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.fillStyle = "#ff0000";
            ctx.font = "bold 24px monospace";
            ctx.textAlign = "center";
            ctx.shadowColor = "black";
            ctx.shadowBlur = 4;
            ctx.fillText("PENALTY", 0, -30);
        }

        ctx.restore();
    }
}

/** GAME SYSTEM */

function isPointInTrack(px, py) {
    for (let i = 0; i < activeTrack.length - 1; i++) {
        if (distToSegment(px, py, activeTrack[i].x, activeTrack[i].y, activeTrack[i+1].x, activeTrack[i+1].y) < TRACK_WIDTH/2) return true;
    }
    if (distToSegment(px, py, activeTrack[activeTrack.length-1].x, activeTrack[activeTrack.length-1].y, activeTrack[0].x, activeTrack[0].y) < TRACK_WIDTH/2) return true;
    return false;
}

function distToSegment(x, y, x1, y1, x2, y2) {
    const A = x - x1; const B = y - y1;
    const C = x2 - x1; const D = y2 - y1;
    const dot = A * C + B * D;
    const len_sq = C * C + D * D;
    let param = -1;
    if (len_sq != 0) param = dot / len_sq;
    let xx, yy;
    if (param < 0) { xx = x1; yy = y1; }
    else if (param > 1) { xx = x2; yy = y2; }
    else { xx = x1 + param * C; yy = y1 + param * D; }
    const dx = x - xx; const dy = y - yy;
    return Math.sqrt(dx * dx + dy * dy);
}

function generateGrandstands() {
    grandstands = [];
    const points = activeTrack;
    const addStand = (p1, p2) => {
        const d = dist(p1.x, p1.y, p2.x, p2.y);
        if (d > 400) { 
            const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
            const offsetX = Math.cos(angle + Math.PI/2) * (TRACK_WIDTH/2 + 30);
            const offsetY = Math.sin(angle + Math.PI/2) * (TRACK_WIDTH/2 + 30);
            grandstands.push({ x: p1.x + offsetX, y: p1.y + offsetY, w: d, h: 40, angle: angle });
        }
    };
    for(let i=0; i<points.length-1; i++) addStand(points[i], points[i+1]);
    addStand(points[points.length-1], points[0]);
}

function showMenu() {
    gameState = 'MENU';
    document.getElementById('main-menu').classList.remove('hidden');
    document.getElementById('pause-menu').classList.add('hidden');
    document.getElementById('ui-layer').classList.add('hidden');
    document.getElementById('results-menu').classList.add('hidden');
    document.getElementById('penalty-overlay').classList.add('hidden');
    activeTrack = MAPS["SILVERSTONE"]; 
    setupGrid(true); 
}

function startGame() {
    const mapKey = document.getElementById('map-select').value;
    difficultySetting = document.getElementById('diff-select').value;
    selectedTeamId = parseInt(document.getElementById('team-select').value);
    
    // Copy the map data
    activeTrack = [...MAPS[mapKey]];
    
    // IF MONTREAL, REVERSE THE ARRAY TO DRIVE OTHER WAY (Fixes "wrong side")
    if (mapKey === "MONTREAL") {
        activeTrack.reverse();
    }
    
    generateGrandstands();

    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('ui-layer').classList.remove('hidden');
    document.getElementById('results-menu').classList.add('hidden');
    document.getElementById('penalty-overlay').classList.add('hidden');
    document.getElementById('warn-count').innerText = "0";
    
    setupGrid(false);
    startCountdown();
}

function restartRace() {
    startGame();
}

function setupGrid(isDemo) {
    cars = [];
    
    // CRITICAL FIX: Calculate orientation based on P0 -> P1 
    // This ensures cars face the correct "Next Point" regardless of track direction
    const pStart = activeTrack[0];
    const pNext = activeTrack[1]; 
    trackStartAngle = Math.atan2(pNext.y - pStart.y, pNext.x - pStart.x);
    
    const backAngle = trackStartAngle + Math.PI;
    const sideAngle = trackStartAngle + Math.PI/2; 

    for (let i = 0; i < TOTAL_CARS; i++) {
        let isPlayer = (i === TOTAL_CARS - 1) && !isDemo;
        const row = Math.floor(i / 2);
        const col = i % 2; 
        
        const distBack = 300 + (row * 90);
        // FIX: Swapped logic to flip grid side
        const latOffset = (col === 0 ? 1 : -1) * 35; 
        
        const startX = pStart.x + (Math.cos(backAngle) * distBack) + (Math.cos(sideAngle) * latOffset);
        const startY = pStart.y + (Math.sin(backAngle) * distBack) + (Math.sin(sideAngle) * latOffset);
        
        let team = isPlayer ? TEAMS.find(t => t.id === selectedTeamId) : TEAMS[Math.floor(Math.random() * TEAMS.length)];
        let skill = 1.0;
        if(difficultySetting === "ROOKIE") skill = 0.85;
        if(difficultySetting === "LEGEND") skill = 1.1;
        if (isDemo) skill = 0.8; 

        cars.push(new Car(isPlayer, startX, startY, trackStartAngle, team, skill, i));
    }

    if(!isDemo && cars.length > 0) {
        camera.x = cars[TOTAL_CARS-1].x;
        camera.y = cars[TOTAL_CARS-1].y;
    }
}

function startCountdown() {
    gameState = 'COUNTDOWN';
    const ui = document.getElementById('center-msg');
    ui.innerText = "";
    
    let count = 4;
    if(countdownTimer) clearInterval(countdownTimer);
    
    countdownTimer = setInterval(() => {
        count--;
        if (count > 0) {
            ui.innerText = count;
            ui.style.color = "red";
        } else {
            clearInterval(countdownTimer);
            ui.innerText = "GO!";
            ui.style.color = "#00ff00";
            gameState = 'RACING';
            const now = Date.now();
            
            // Set Start Times
            cars.forEach(c => {
                c.currentLapStart = now;
                c.raceStartTime = now;
            });
            
            setTimeout(() => { if(gameState==='RACING') ui.innerText = ""; }, 1000);
        }
    }, 1000);
}

function drawTrack() {
    ctx.save();
    grandstands.forEach(g => {
        ctx.translate(g.x, g.y);
        ctx.rotate(g.angle);
        ctx.fillStyle = "#555"; 
        ctx.fillRect(0, 0, g.w, g.h);
        ctx.fillStyle = `hsl(${Date.now() % 360}, 60%, 50%)`; 
        for(let i=0; i<g.w; i+=10) {
             if(Math.random()>0.5) ctx.fillRect(i, 5, 4, 4);
             if(Math.random()>0.5) ctx.fillRect(i, 15, 4, 4);
        }
        ctx.rotate(-g.angle);
        ctx.translate(-g.x, -g.y);
    });
    ctx.restore();

    ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    
    ctx.strokeStyle = "#fff"; ctx.lineWidth = TRACK_WIDTH + 24;
    ctx.beginPath(); ctx.moveTo(activeTrack[0].x, activeTrack[0].y);
    activeTrack.forEach(p => ctx.lineTo(p.x, p.y)); ctx.closePath(); ctx.stroke();
    
    ctx.strokeStyle = "#e60000"; ctx.setLineDash([40, 40]);
    ctx.stroke(); ctx.setLineDash([]);
    
    ctx.strokeStyle = "#333"; ctx.lineWidth = TRACK_WIDTH;
    ctx.beginPath(); ctx.moveTo(activeTrack[0].x, activeTrack[0].y);
    activeTrack.forEach(p => ctx.lineTo(p.x, p.y)); ctx.closePath(); ctx.stroke();

    if (gameState === 'RACING' || gameState === 'COUNTDOWN') {
        ctx.strokeStyle = "rgba(0, 255, 255, 0.3)";
        ctx.lineWidth = 10;
        ctx.beginPath();
        ctx.moveTo(activeTrack[0].x, activeTrack[0].y);
        activeTrack.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.closePath();
        ctx.stroke();
    }

    ctx.save();
    const pStart = activeTrack[0];
    ctx.translate(pStart.x, pStart.y);
    ctx.rotate(trackStartAngle + Math.PI/2); 
    
    ctx.fillStyle = "white"; 
    ctx.fillRect(-TRACK_WIDTH/2, -10, TRACK_WIDTH, 20);
    for(let r=0; r<2; r++){
        for(let c=0; c<10; c++){
             ctx.fillStyle = (r+c)%2===0 ? "black" : "white";
             ctx.fillRect(-TRACK_WIDTH/2 + (c*TRACK_WIDTH/10), -10 + (r*10), TRACK_WIDTH/10, 10);
        }
    }
    ctx.restore();
    
    if(gameState === 'COUNTDOWN' || gameState === 'START' || gameState === 'MENU') {
        ctx.fillStyle = "rgba(255,255,255,0.3)";
        const backAngle = trackStartAngle + Math.PI;
        const sideAngle = trackStartAngle + Math.PI/2;
        
        for(let i=0; i<TOTAL_CARS; i++) {
            const row = Math.floor(i / 2);
            const col = i % 2; 
            const distBack = 300 + (row * 90);
            
            // MATCHED GRID OFFSET TO CAR OFFSET
            const latOffset = (col === 0 ? 1 : -1) * 35;
            
            const gx = pStart.x + (Math.cos(backAngle) * distBack) + (Math.cos(sideAngle) * latOffset);
            const gy = pStart.y + (Math.sin(backAngle) * distBack) + (Math.sin(sideAngle) * latOffset);
            
            ctx.save();
            ctx.translate(gx, gy);
            ctx.rotate(trackStartAngle);
            ctx.fillRect(-15, -15, 30, 30);
            ctx.restore();
        }
    }
}

function updateUI() {
    if (gameState !== 'RACING' && gameState !== 'FINISHED') return;

    const player = cars[TOTAL_CARS-1];
    
    const speed = Math.sqrt(player.vx**2 + player.vy**2) * 20; 
    document.getElementById('speed').innerText = Math.floor(speed);
    
    let gear = "1";
    if(speed > 50) gear = "2"; if(speed > 100) gear = "3";
    if(speed > 160) gear = "4"; if(speed > 220) gear = "5";
    if(speed > 270) gear = "6"; if(player.finished) gear = "N";
    document.getElementById('gear').innerText = gear;

    const getScore = (c) => (c.lap * 10000) + (10000 - dist(c.x, c.y, activeTrack[c.nextWaypointIndex].x, activeTrack[c.nextWaypointIndex].y)) + (c.nextWaypointIndex*1000);
    const sorted = [...cars].sort((a,b) => getScore(b) - getScore(a));
    const rank = sorted.indexOf(player) + 1;
    
    document.getElementById('pos-disp').innerText = rank;
    document.getElementById('lap-disp').innerText = Math.min(player.lap, TOTAL_LAPS);
    
    const now = Date.now();
    const curTime = (now - player.currentLapStart) / 1000;
    if(!player.finished && gameState === 'RACING') document.getElementById('cur-time').innerText = curTime.toFixed(2);
    if (player.lastLapTime > 0) document.getElementById('last-lap').innerText = player.lastLapTime.toFixed(2);

    if (player.finished && gameState !== 'FINISHED') {
        gameState = 'FINISHED';
        
        // Show Results Screen
        document.getElementById('results-menu').classList.remove('hidden');
        document.getElementById('res-pos').innerText = "P" + rank;
        document.getElementById('res-pos').style.color = (rank <= 3) ? "#00ff00" : "#e63946";
        
        // FIX: Display Actual Total Race Time
        const tTime = player.totalRaceTime;
        let mins = Math.floor(tTime / 60);
        let secs = (tTime % 60).toFixed(2);
        document.getElementById('res-time').innerText = (mins > 0 ? mins + ":" : "") + (secs < 10 && mins > 0 ? "0" : "") + secs;
        
        let bMins = Math.floor(player.bestLapTime / 60);
        let bSecs = (player.bestLapTime % 60).toFixed(2);
        if(player.bestLapTime < 900) {
             document.getElementById('res-best').innerText = (bMins > 0 ? bMins + ":" : "") + (bSecs < 10 && bMins > 0 ? "0" : "") + bSecs;
        } else {
             document.getElementById('res-best').innerText = "--:--";
        }
    }
}

function loop() {
    ctx.fillStyle = "#203a20"; 
    ctx.fillRect(0, 0, width, height);
    
    let targetX = 0, targetY = 0;
    if (cars.length > 0) {
        const followCar = (gameState === 'MENU') ? cars[0] : cars[TOTAL_CARS-1];
        if (followCar) {
            targetX = followCar.x + (gameState === 'MENU' ? 0 : mouse.x * 0.4);
            targetY = followCar.y + (gameState === 'MENU' ? 0 : mouse.y * 0.4);
        }
    }
    camera.x += (targetX - camera.x) * 0.1;
    camera.y += (targetY - camera.y) * 0.1;

    ctx.save();
    ctx.translate(width/2 - camera.x, height/2 - camera.y);
    
    drawTrack();
    
    if (gameState !== 'PAUSED') {
        cars.forEach(c => c.update());
    }
    cars.forEach(c => c.draw());
    
    ctx.restore();
    updateUI();
    requestAnimationFrame(loop);
}

showMenu();
loop();
</script>
</body>
</html>
